<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Pembelajaran Online - International University of Papua</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .header h1 {
            color: #2c3e50;
            font-size: 2.5em;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .header .subtitle {
            color: #7f8c8d;
            font-size: 1.2em;
            margin-bottom: 20px;
        }

        .login-section {
            background: rgba(52, 152, 219, 0.1);
            border: 2px solid #3498db;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .login-title {
            color: #2c3e50;
            font-size: 1.1em;
            font-weight: 600;
            margin-bottom: 15px;
            text-align: center;
        }

        .admin-controls {
            display: none;
            background: rgba(231, 76, 60, 0.1);
            border: 2px solid #e74c3c;
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
        }

        .form-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #bdc3c7;
            border-radius: 10px;
            font-size: 16px;
            margin-bottom: 15px;
            transition: border-color 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: #3498db;
        }

        .login-btn, .admin-btn {
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: all 0.3s ease;
        }

        .login-btn:hover, .admin-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(52, 152, 219, 0.3);
        }

        .main-content {
            display: none;
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .nav-tabs {
            display: flex;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            padding: 10px;
            margin-bottom: 30px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            flex-wrap: wrap;
            gap: 10px;
        }

        .nav-tab {
            flex: 1;
            min-width: 120px;
            padding: 15px 20px;
            background: transparent;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #7f8c8d;
        }

        .nav-tab.active {
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(52, 152, 219, 0.3);
        }

        .nav-tab:hover:not(.active) {
            background: rgba(52, 152, 219, 0.1);
            color: #2980b9;
        }

        .content-section {
            display: none;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
        }

        .content-section.active {
            display: block;
        }

        .section-title {
            color: #2c3e50;
            font-size: 2em;
            font-weight: 700;
            margin-bottom: 25px;
            border-bottom: 3px solid #3498db;
            padding-bottom: 10px;
        }

        .announcement-card {
            background: linear-gradient(135deg, #74b9ff, #0984e3);
            color: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(116, 185, 255, 0.3);
            transition: transform 0.3s ease;
        }

        .announcement-card:hover {
            transform: translateY(-5px);
        }

        .announcement-date {
            font-size: 0.9em;
            opacity: 0.9;
            margin-bottom: 10px;
        }

        .announcement-title {
            font-size: 1.3em;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .course-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-top: 20px;
        }

        .course-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            border-left: 5px solid #3498db;
        }

        .course-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
        }

        .course-title {
            color: #2c3e50;
            font-size: 1.3em;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .course-info {
            color: #7f8c8d;
            font-size: 0.9em;
            margin-bottom: 15px;
        }

        .course-description {
            color: #5a6c7d;
            margin-bottom: 20px;
            line-height: 1.6;
        }

        .course-btn {
            background: linear-gradient(45deg, #00b894, #00a085);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
        }

        .course-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 184, 148, 0.3);
        }

        .schedule-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .schedule-table th {
            background: linear-gradient(45deg, #6c5ce7, #5f3dc4);
            color: white;
            padding: 20px;
            text-align: left;
            font-weight: 600;
        }

        .schedule-table td {
            padding: 18px 20px;
            border-bottom: 1px solid #ecf0f1;
        }

        .schedule-table tr:hover {
            background: rgba(108, 92, 231, 0.05);
        }

        .time-slot {
            font-weight: 600;
            color: #6c5ce7;
        }

        .edit-form {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }

        .form-textarea, .form-select {
            width: 100%;
            padding: 12px;
            border: 2px solid #bdc3c7;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-input:focus, .form-textarea:focus, .form-select:focus {
            outline: none;
            border-color: #3498db;
        }

        .form-textarea {
            min-height: 120px;
            resize: vertical;
        }

        .save-btn, .add-btn {
            background: linear-gradient(45deg, #00b894, #00a085);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-right: 10px;
        }

        .save-btn:hover, .add-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 184, 148, 0.3);
        }

        .delete-btn {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .delete-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.3);
        }

        .course-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 800px;
            max-height: 90vh;
            width: 90%;
            overflow-y: auto;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #ecf0f1;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #7f8c8d;
            transition: color 0.3s ease;
        }

        .close-btn:hover {
            color: #e74c3c;
        }

        .module-item {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 4px solid #3498db;
        }

        .module-title {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .file-link {
            color: #3498db;
            text-decoration: none;
            font-weight: 500;
            transition: color 0.3s ease;
        }

        .file-link:hover {
            color: #2980b9;
            text-decoration: underline;
        }

        .logout-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            z-index: 100;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(231, 76, 60, 0.3);
        }

        .error-message {
            background: #ffe6e6;
            border: 2px solid #e74c3c;
            color: #c0392b;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .nav-tabs {
                flex-direction: column;
            }
            
            .nav-tab {
                min-width: 100%;
            }
            
            .course-grid {
                grid-template-columns: 1fr;
            }
            
            .modal-content {
                width: 95%;
                padding: 20px;
            }
            
            .schedule-table {
                font-size: 14px;
            }
            
            .schedule-table th,
            .schedule-table td {
                padding: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>🎓 Sistem Pembelajaran Online</h1>
            <div class="subtitle">Energy System Engineering - International University of Papua</div>
            
            <div class="login-section">
                <div class="login-title">Masuk ke Sistem</div>
                <div class="error-message" id="loginError"></div>
                <input type="email" class="form-input" id="loginEmail" placeholder="Email">
                <input type="password" class="form-input" id="loginPassword" placeholder="Password">
                <button class="login-btn" onclick="login()">Masuk</button>
                <p style="color: #7f8c8d; margin-top: 15px; font-size: 0.9em;">
                    Demo: admin@iup.ac.id / Admin123! (admin) atau student@iup.ac.id / Student123! (mahasiswa)
                </p>
            </div>
            
            <div class="admin-controls" id="adminControls">
                <div class="login-title">Panel Admin - Mode Edit Aktif</div>
                <p style="color: #7f8c8d; margin-bottom: 15px;">Anda login sebagai admin. Semua fitur edit tersedia.</p>
            </div>
        </div>

        <!-- Logout Button -->
        <button class="logout-btn" id="logoutBtn" onclick="logout()" style="display: none;">Keluar</button>

        <!-- Main Content -->
        <div class="main-content" id="mainContent">
            <!-- Navigation Tabs -->
            <div class="nav-tabs">
                <button class="nav-tab active" onclick="showSection('announcements')">📢 Pengumuman</button>
                <button class="nav-tab" onclick="showSection('schedule')">📅 Jadwal Kuliah</button>
                <button class="nav-tab" onclick="showSection('courses')">📚 Mata Kuliah</button>
            </div>

            <!-- Announcements Section -->
            <div class="content-section active" id="announcements">
                <h2 class="section-title">📢 Pengumuman Terbaru</h2>
                
                <div class="error-message" id="announcementError"></div>
                
                <div class="edit-form" id="announcementForm" style="display: none;">
                    <h3>Tambah Pengumuman</h3>
                    <div class="form-group">
                        <label class="form-label">Judul Pengumuman</label>
                        <input type="text" class="form-input" id="announcementTitle" placeholder="Masukkan judul pengumuman">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Isi Pengumuman</label>
                        <textarea class="form-textarea" id="announcementContent" placeholder="Masukkan isi pengumuman"></textarea>
                    </div>
                    <button class="save-btn" onclick="saveAnnouncement()">Simpan Pengumuman</button>
                    <button class="add-btn" onclick="cancelAnnouncementEdit()">Batal</button>
                </div>

                <div id="announcementsList">
                    <div class="loading">Memuat pengumuman...</div>
                </div>

                <button class="add-btn" id="addAnnouncementBtn" onclick="showAnnouncementForm()" style="display: none; margin-top: 20px;">+ Tambah Pengumuman</button>
            </div>

            <!-- Schedule Section -->
            <div class="content-section" id="schedule">
                <h2 class="section-title">📅 Jadwal Kuliah Mingguan</h2>
                
                <div class="error-message" id="scheduleError"></div>
                
                <div class="edit-form" id="scheduleForm" style="display: none;">
                    <h3>Tambah Jadwal</h3>
                    <div class="form-group">
                        <label class="form-label">Hari</label>
                        <select class="form-select" id="scheduleDay">
                            <option value="Senin">Senin</option>
                            <option value="Selasa">Selasa</option>
                            <option value="Rabu">Rabu</option>
                            <option value="Kamis">Kamis</option>
                            <option value="Jumat">Jumat</option>
                            <option value="Sabtu">Sabtu</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Waktu</label>
                        <input type="text" class="form-input" id="scheduleTime" placeholder="08:00 - 09:40">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Mata Kuliah</label>
                        <input type="text" class="form-input" id="scheduleCourse" placeholder="Nama mata kuliah">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Ruangan</label>
                        <input type="text" class="form-input" id="scheduleRoom" placeholder="Ruang kelas">
                    </div>
                    <button class="save-btn" onclick="saveSchedule()">Simpan Jadwal</button>
                    <button class="add-btn" onclick="cancelScheduleEdit()">Batal</button>
                </div>

                <table class="schedule-table" id="scheduleTable">
                    <thead>
                        <tr>
                            <th>Hari</th>
                            <th>Waktu</th>
                            <th>Mata Kuliah</th>
                            <th>Ruangan</th>
                            <th class="admin-only" style="display: none;">Aksi</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="5" class="loading">Memuat jadwal...</td>
                        </tr>
                    </tbody>
                </table>

                <button class="add-btn" id="addScheduleBtn" onclick="showScheduleForm()" style="display: none; margin-top: 20px;">+ Tambah Jadwal</button>
            </div>

            <!-- Courses Section -->
            <div class="content-section" id="courses">
                <h2 class="section-title">📚 Mata Kuliah & Materi</h2>
                
                <div class="error-message" id="courseError"></div>
                
                <div class="edit-form" id="courseForm" style="display: none;">
                    <h3>Tambah Mata Kuliah</h3>
                    <div class="form-group">
                        <label class="form-label">Nama Mata Kuliah</label>
                        <input type="text" class="form-input" id="courseName" placeholder="Nama mata kuliah">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Kode Mata Kuliah</label>
                        <input type="text" class="form-input" id="courseCode" placeholder="Kode mata kuliah">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Dosen Pengampu</label>
                        <input type="text" class="form-input" id="courseLecturer" placeholder="Nama dosen">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Deskripsi</label>
                        <textarea class="form-textarea" id="courseDescription" placeholder="Deskripsi mata kuliah"></textarea>
                    </div>
                    <button class="save-btn" onclick="saveCourse()">Simpan Mata Kuliah</button>
                    <button class="add-btn" onclick="cancelCourseEdit()">Batal</button>
                </div>

                <div class="course-grid" id="courseGrid">
                    <div class="loading">Memuat mata kuliah...</div>
                </div>

                <button class="add-btn" id="addCourseBtn" onclick="showCourseForm()" style="display: none; margin-top: 20px;">+ Tambah Mata Kuliah</button>
            </div>
        </div>

        <!-- Course Modal -->
        <div class="course-modal" id="courseModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="modalTitle">Detail Mata Kuliah</h2>
                    <button class="close-btn" onclick="closeCourseModal()">&times;</button>
                </div>
                
                <div class="error-message" id="moduleError"></div>
                
                <div id="courseContent">
                    <div class="loading">Memuat materi...</div>
                </div>
                
                <div class="edit-form" id="moduleForm" style="display: none;">
                    <h3>Tambah Modul</h3>
                    <div class="form-group">
                        <label class="form-label">Judul Modul</label>
                        <input type="text" class="form-input" id="moduleTitle" placeholder="Judul modul">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Deskripsi Modul</label>
                        <textarea class="form-textarea" id="moduleDescription" placeholder="Deskripsi modul"></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Link File/Materi</label>
                        <input type="text" class="form-input" id="moduleFile" placeholder="URL file atau materi (gunakan '#' untuk placeholder)">
                    </div>
                    <button class="save-btn" onclick="saveModule()">Simpan Modul</button>
                    <button class="add-btn" onclick="cancelModuleEdit()">Batal</button>
                </div>
                
                <button class="add-btn" id="addModuleBtn" onclick="showModuleForm()" style="display: none; margin-top: 20px;">+ Tambah Modul</button>
            </div>
        </div>
    </div>

    <!-- Supabase Client Library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script>
        // ==================== CONFIGURATION ====================
        // TODO: Replace these with your actual Supabase credentials
        const SUPABASE_URL = 'YOUR_SUPABASE_URL_HERE';
        const SUPABASE_ANON_KEY = 'YOUR_SUPABASE_ANON_KEY_HERE';
        
        // Initialize Supabase client
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // ==================== GLOBAL STATE ====================
        let currentUser = null;
        let isAdminMode = false;
        let currentCourseId = null;
        let currentCourseDbId = null;

        // ==================== AUTH FUNCTIONS ====================
        
        async function login() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;
            
            if (!email || !password) {
                showError('loginError', 'Harap isi email dan password!');
                return;
            }
            
            try {
                // Sign in with Supabase Auth
                const { data, error } = await supabase.auth.signInWithPassword({
                    email: email,
                    password: password
                });
                
                if (error) throw error;
                
                currentUser = data.user;
                
                // Check if user is admin
                const { data: roleData, error: roleError } = await supabase
                    .from('user_roles')
                    .select('role')
                    .eq('id', currentUser.id)
                    .single();
                
                if (roleError && roleError.code !== 'PGRST116') {
                    console.error('Role check error:', roleError);
                }
                
                isAdminMode = roleData && roleData.role === 'admin';
                
                // Clear login form
                document.getElementById('loginEmail').value = '';
                document.getElementById('loginPassword').value = '';
                hideError('loginError');
                
                // Show main content
                showMainContent();
                
                // Load all data
                await Promise.all([
                    loadAnnouncements(),
                    loadSchedules(),
                    loadCourses()
                ]);
                
            } catch (error) {
                console.error('Login error:', error);
                showError('loginError', 'Login gagal: ' + error.message);
            }
        }
        
        async function logout() {
            try {
                await supabase.auth.signOut();
                currentUser = null;
                isAdminMode = false;
                hideMainContent();
            } catch (error) {
                console.error('Logout error:', error);
                alert('Gagal logout: ' + error.message);
            }
        }
        
        function showMainContent() {
            document.querySelector('.header').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';
            document.getElementById('logoutBtn').style.display = 'block';
            
            if (isAdminMode) {
                showAdminControls();
            }
        }
        
        function hideMainContent() {
            document.querySelector('.header').style.display = 'block';
            document.getElementById('mainContent').style.display = 'none';
            document.getElementById('logoutBtn').style.display = 'none';
            hideAdminControls();
        }
        
        function showAdminControls() {
            document.getElementById('adminControls').style.display = 'block';
            
            // Show admin-only elements
            document.querySelectorAll('.admin-only').forEach(el => {
                el.style.display = 'table-cell';
            });
            
            document.querySelectorAll('.delete-btn').forEach(el => {
                el.style.display = 'inline-block';
            });
            
            document.getElementById('addAnnouncementBtn').style.display = 'block';
            document.getElementById('addScheduleBtn').style.display = 'block';
            document.getElementById('addCourseBtn').style.display = 'block';
        }
        
        function hideAdminControls() {
            document.getElementById('adminControls').style.display = 'none';
            
            document.querySelectorAll('.admin-only').forEach(el => {
                el.style.display = 'none';
            });
            
            document.querySelectorAll('.delete-btn').forEach(el => {
                el.style.display = 'none';
            });
            
            document.getElementById('addAnnouncementBtn').style.display = 'none';
            document.getElementById('addScheduleBtn').style.display = 'none';
            document.getElementById('addCourseBtn').style.display = 'none';
        }

        // ==================== ANNOUNCEMENTS ====================
        
        async function loadAnnouncements() {
            try {
                const { data, error } = await supabase
                    .from('announcements')
                    .select('*')
                    .order('date_created', { ascending: false });
                
                if (error) throw error;
                
                const container = document.getElementById('announcementsList');
                
                if (!data || data.length === 0) {
                    container.innerHTML = '<div class="loading">Belum ada pengumuman.</div>';
                    return;
                }
                
                container.innerHTML = data.map(announcement => `
                    <div class="announcement-card" data-id="${announcement.id}">
                        <div class="announcement-date">${formatDate(announcement.date_created)}</div>
                        <div class="announcement-title">${escapeHtml(announcement.title)}</div>
                        <div class="announcement-content">${escapeHtml(announcement.content)}</div>
                        <button class="delete-btn" onclick="deleteAnnouncement('${announcement.id}')" style="display: ${isAdminMode ? 'inline-block' : 'none'};">Hapus</button>
                    </div>
                `).join('');
                
            } catch (error) {
                console.error('Load announcements error:', error);
                showError('announcementError', 'Gagal memuat pengumuman: ' + error.message);
            }
        }
        
        function showAnnouncementForm() {
            document.getElementById('announcementForm').style.display = 'block';
            document.getElementById('announcementTitle').value = '';
            document.getElementById('announcementContent').value = '';
        }
        
        function cancelAnnouncementEdit() {
            document.getElementById('announcementForm').style.display = 'none';
        }
        
        async function saveAnnouncement() {
            const title = document.getElementById('announcementTitle').value.trim();
            const content = document.getElementById('announcementContent').value.trim();
            
            if (!title || !content) {
                showError('announcementError', 'Harap isi semua field!');
                return;
            }
            
            try {
                const { error } = await supabase
                    .from('announcements')
                    .insert([{
                        title: title,
                        content: content,
                        created_by: currentUser.id
                    }]);
                
                if (error) throw error;
                
                // Reload announcements
                await loadAnnouncements();
                
                // Hide form
                cancelAnnouncementEdit();
                hideError('announcementError');
                
            } catch (error) {
                console.error('Save announcement error:', error);
                showError('announcementError', 'Gagal menyimpan pengumuman: ' + error.message);
            }
        }
        
        async function deleteAnnouncement(id) {
            if (!confirm('Yakin ingin menghapus pengumuman ini?')) return;
            
            try {
                const { error } = await supabase
                    .from('announcements')
                    .delete()
                    .eq('id', id);
                
                if (error) throw error;
                
                // Reload announcements
                await loadAnnouncements();
                
            } catch (error) {
                console.error('Delete announcement error:', error);
                showError('announcementError', 'Gagal menghapus pengumuman: ' + error.message);
            }
        }

        // ==================== SCHEDULES ====================
        
        async function loadSchedules() {
            try {
                const { data, error } = await supabase
                    .from('schedules')
                    .select('*')
                    .order('day', { ascending: true });
                
                if (error) throw error;
                
                const tbody = document.querySelector('#scheduleTable tbody');
                
                if (!data || data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="loading">Belum ada jadwal.</td></tr>';
                    return;
                }
                
                // Sort by day order
                const dayOrder = ['Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'];
                data.sort((a, b) => dayOrder.indexOf(a.day) - dayOrder.indexOf(b.day));
                
                tbody.innerHTML = data.map(schedule => `
                    <tr data-id="${schedule.id}">
                        <td>${escapeHtml(schedule.day)}</td>
                        <td class="time-slot">${escapeHtml(schedule.time)}</td>
                        <td>${escapeHtml(schedule.course)}</td>
                        <td>${escapeHtml(schedule.room)}</td>
                        <td class="admin-only" style="display: ${isAdminMode ? 'table-cell' : 'none'};">
                            <button class="delete-btn" onclick="deleteSchedule('${schedule.id}')">Hapus</button>
                        </td>
                    </tr>
                `).join('');
                
            } catch (error) {
                console.error('Load schedules error:', error);
                showError('scheduleError', 'Gagal memuat jadwal: ' + error.message);
            }
        }
        
        function showScheduleForm() {
            document.getElementById('scheduleForm').style.display = 'block';
            document.getElementById('scheduleDay').value = 'Senin';
            document.getElementById('scheduleTime').value = '';
            document.getElementById('scheduleCourse').value = '';
            document.getElementById('scheduleRoom').value = '';
        }
        
        function cancelScheduleEdit() {
            document.getElementById('scheduleForm').style.display = 'none';
        }
        
        async function saveSchedule() {
            const day = document.getElementById('scheduleDay').value;
            const time = document.getElementById('scheduleTime').value.trim();
            const course = document.getElementById('scheduleCourse').value.trim();
            const room = document.getElementById('scheduleRoom').value.trim();
            
            if (!time || !course || !room) {
                showError('scheduleError', 'Harap isi semua field!');
                return;
            }
            
            try {
                const { error } = await supabase
                    .from('schedules')
                    .insert([{
                        day: day,
                        time: time,
                        course: course,
                        room: room,
                        created_by: currentUser.id
                    }]);
                
                if (error) throw error;
                
                await loadSchedules();
                cancelScheduleEdit();
                hideError('scheduleError');
                
            } catch (error) {
                console.error('Save schedule error:', error);
                showError('scheduleError', 'Gagal menyimpan jadwal: ' + error.message);
            }
        }
        
        async function deleteSchedule(id) {
            if (!confirm('Yakin ingin menghapus jadwal ini?')) return;
            
            try {
                const { error } = await supabase
                    .from('schedules')
                    .delete()
                    .eq('id', id);
                
                if (error) throw error;
                
                await loadSchedules();
                
            } catch (error) {
                console.error('Delete schedule error:', error);
                showError('scheduleError', 'Gagal menghapus jadwal: ' + error.message);
            }
        }

        // ==================== COURSES ====================
        
        async function loadCourses() {
            try {
                const { data, error } = await supabase
                    .from('courses')
                    .select('*')
                    .order('created_at', { ascending: true });
                
                if (error) throw error;
                
                const container = document.getElementById('courseGrid');
                
                if (!data || data.length === 0) {
                    container.innerHTML = '<div class="loading">Belum ada mata kuliah.</div>';
                    return;
                }
                
                container.innerHTML = data.map(course => `
                    <div class="course-card" data-id="${course.id}">
                        <div class="course-title">${escapeHtml(course.title)}</div>
                        <div class="course-info">${escapeHtml(course.code)} • ${escapeHtml(course.lecturer)}</div>
                        <div class="course-description">${escapeHtml(course.description)}</div>
                        <button class="course-btn" onclick="openCourse('${course.id}', '${escapeHtml(course.course_id)}')">Akses Materi</button>
                        <button class="delete-btn" onclick="deleteCourse('${course.id}')" style="display: ${isAdminMode ? 'inline-block' : 'none'}; margin-top: 10px; width: 100%;">Hapus Mata Kuliah</button>
                    </div>
                `).join('');
                
            } catch (error) {
                console.error('Load courses error:', error);
                showError('courseError', 'Gagal memuat mata kuliah: ' + error.message);
            }
        }
        
        function showCourseForm() {
            document.getElementById('courseForm').style.display = 'block';
            document.getElementById('courseName').value = '';
            document.getElementById('courseCode').value = '';
            document.getElementById('courseLecturer').value = '';
            document.getElementById('courseDescription').value = '';
        }
        
        function cancelCourseEdit() {
            document.getElementById('courseForm').style.display = 'none';
        }
        
        async function saveCourse() {
            const name = document.getElementById('courseName').value.trim();
            const code = document.getElementById('courseCode').value.trim();
            const lecturer = document.getElementById('courseLecturer').value.trim();
            const description = document.getElementById('courseDescription').value.trim();
            
            if (!name || !code || !lecturer || !description) {
                showError('courseError', 'Harap isi semua field!');
                return;
            }
            
            // Generate course_id slug
            const courseId = name.toLowerCase()
                .replace(/\s+/g, '-')
                .replace(/[^a-z0-9-]/g, '');
            
            try {
                const { error } = await supabase
                    .from('courses')
                    .insert([{
                        course_id: courseId,
                        title: name,
                        code: code,
                        lecturer: lecturer,
                        description: description,
                        created_by: currentUser.id
                    }]);
                
                if (error) throw error;
                
                await loadCourses();
                cancelCourseEdit();
                hideError('courseError');
                
            } catch (error) {
                console.error('Save course error:', error);
                showError('courseError', 'Gagal menyimpan mata kuliah: ' + error.message);
            }
        }
        
        async function deleteCourse(id) {
            if (!confirm('Yakin ingin menghapus mata kuliah ini? Semua modul akan ikut terhapus.')) return;
            
            try {
                const { error } = await supabase
                    .from('courses')
                    .delete()
                    .eq('id', id);
                
                if (error) throw error;
                
                await loadCourses();
                
            } catch (error) {
                console.error('Delete course error:', error);
                showError('courseError', 'Gagal menghapus mata kuliah: ' + error.message);
            }
        }

        // ==================== MODULES ====================
        
        async function openCourse(dbId, courseId) {
            currentCourseDbId = dbId;
            currentCourseId = courseId;
            
            try {
                // Get course details
                const { data: courseData, error: courseError } = await supabase
                    .from('courses')
                    .select('*')
                    .eq('id', dbId)
                    .single();
                
                if (courseError) throw courseError;
                
                document.getElementById('modalTitle').textContent = courseData.title;
                
                // Get modules
                const { data: modules, error: modulesError } = await supabase
                    .from('modules')
                    .select('*')
                    .eq('course_id', dbId)
                    .order('order_index', { ascending: true });
                
                if (modulesError) throw modulesError;
                
                let contentHtml = `
                    <div style="margin-bottom: 20px; padding: 20px; background: #f8f9fa; border-radius: 10px;">
                        <h3>Informasi Mata Kuliah</h3>
                        <p><strong>Kode:</strong> ${escapeHtml(courseData.code)}</p>
                        <p><strong>Dosen Pengampu:</strong> ${escapeHtml(courseData.lecturer)}</p>
                    </div>
                    
                    <h3 style="margin-bottom: 20px; color: #2c3e50;">📖 Modul Pembelajaran</h3>
                `;
                
                if (modules && modules.length > 0) {
                    contentHtml += modules.map(module => `
                        <div class="module-item" data-id="${module.id}">
                            <div class="module-title">${escapeHtml(module.title)}</div>
                            <div style="margin-bottom: 10px; color: #5a6c7d;">${escapeHtml(module.description)}</div>
                            <a href="${module.file_link === '#' ? '#' : escapeHtml(module.file_link)}" class="file-link" ${module.file_link === '#' ? 'onclick="alert(\'File belum tersedia\'); return false;"' : 'target="_blank"'}>
                                ${module.file_link === '#' ? 'File Placeholder' : 'Download Materi'}
                            </a>
                            ${isAdminMode ? `<button class="delete-btn" onclick="deleteModule('${module.id}')" style="float: right;">Hapus</button>` : ''}
                        </div>
                    `).join('');
                } else {
                    contentHtml += '<div style="text-align: center; color: #7f8c8d; padding: 40px;">Belum ada modul yang tersedia.</div>';
                }
                
                document.getElementById('courseContent').innerHTML = contentHtml;
                document.getElementById('addModuleBtn').style.display = isAdminMode ? 'block' : 'none';
                document.getElementById('courseModal').style.display = 'block';
                hideError('moduleError');
                
            } catch (error) {
                console.error('Open course error:', error);
                showError('moduleError', 'Gagal memuat mata kuliah: ' + error.message);
            }
        }
        
        function closeCourseModal() {
            document.getElementById('courseModal').style.display = 'none';
            document.getElementById('moduleForm').style.display = 'none';
            currentCourseDbId = null;
            currentCourseId = null;
        }
        
        function showModuleForm() {
            document.getElementById('moduleForm').style.display = 'block';
            document.getElementById('moduleTitle').value = '';
            document.getElementById('moduleDescription').value = '';
            document.getElementById('moduleFile').value = '';
        }
        
        function cancelModuleEdit() {
            document.getElementById('moduleForm').style.display = 'none';
        }
        
        async function saveModule() {
            const title = document.getElementById('moduleTitle').value.trim();
            const description = document.getElementById('moduleDescription').value.trim();
            const file = document.getElementById('moduleFile').value.trim() || '#';
            
            if (!title || !description) {
                showError('moduleError', 'Harap isi judul dan deskripsi modul!');
                return;
            }
            
            if (!currentCourseDbId) {
                showError('moduleError', 'Error: Course ID tidak ditemukan!');
                return;
            }
            
            try {
                // Get current max order_index
                const { data: existingModules, error: fetchError } = await supabase
                    .from('modules')
                    .select('order_index')
                    .eq('course_id', currentCourseDbId)
                    .order('order_index', { ascending: false })
                    .limit(1);
                
                if (fetchError) throw fetchError;
                
                const nextOrder = existingModules && existingModules.length > 0 
                    ? existingModules[0].order_index + 1 
                    : 1;
                
                const { error } = await supabase
                    .from('modules')
                    .insert([{
                        course_id: currentCourseDbId,
                        title: title,
                        description: description,
                        file_link: file,
                        order_index: nextOrder,
                        created_by: currentUser.id
                    }]);
                
                if (error) throw error;
                
                // Reload course content
                await openCourse(currentCourseDbId, currentCourseId);
                cancelModuleEdit();
                hideError('moduleError');
                
            } catch (error) {
                console.error('Save module error:', error);
                showError('moduleError', 'Gagal menyimpan modul: ' + error.message);
            }
        }
        
        async function deleteModule(id) {
            if (!confirm('Yakin ingin menghapus modul ini?')) return;
            
            try {
                const { error } = await supabase
                    .from('modules')
                    .delete()
                    .eq('id', id);
                
                if (error) throw error;
                
                // Reload course content
                await openCourse(currentCourseDbId, currentCourseId);
                
            } catch (error) {
                console.error('Delete module error:', error);
                showError('moduleError', 'Gagal menghapus modul: ' + error.message);
            }
        }

        // ==================== NAVIGATION ====================
        
        function showSection(sectionName) {
            // Hide all sections
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected section
            document.getElementById(sectionName).classList.add('active');
            
            // Add active class to clicked tab
            event.target.classList.add('active');
        }

        // ==================== UTILITY FUNCTIONS ====================
        
        function showError(elementId, message) {
            const errorEl = document.getElementById(elementId);
            errorEl.textContent = message;
            errorEl.style.display = 'block';
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                hideError(elementId);
            }, 5000);
        }
        
        function hideError(elementId) {
            const errorEl = document.getElementById(elementId);
            errorEl.style.display = 'none';
        }
        
        function formatDate(dateString) {
            const date = new Date(dateString);
            const options = { day: 'numeric', month: 'long', year: 'numeric' };
            return date.toLocaleDateString('id-ID', options);
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ==================== INIT & EVENT LISTENERS ====================
        
        // Check for existing session on page load
        supabase.auth.getSession().then(({ data: { session } }) => {
            if (session) {
                currentUser = session.user;
                // Check admin role and load content
                supabase
                    .from('user_roles')
                    .select('role')
                    .eq('id', currentUser.id)
                    .single()
                    .then(({ data }) => {
                        isAdminMode = data && data.role === 'admin';
                        showMainContent();
                        Promise.all([
                            loadAnnouncements(),
                            loadSchedules(),
                            loadCourses()
                        ]);
                    });
            }
        });
        
        // Listen for auth state changes
        supabase.auth.onAuthStateChange((event, session) => {
            if (event === 'SIGNED_OUT') {
                currentUser = null;
                isAdminMode = false;
                hideMainContent();
            }
        });
        
        // Close modal when clicking outside
        document.getElementById('courseModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeCourseModal();
            }
        });
        
        // Handle Enter key for login
        document.getElementById('loginPassword').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                login();
            }
        });
        
        // Configuration check on load
        if (SUPABASE_URL === 'YOUR_SUPABASE_URL_HERE' || SUPABASE_ANON_KEY === 'YOUR_SUPABASE_ANON_KEY_HERE') {
            console.error('⚠️ KONFIGURASI BELUM LENGKAP!');
            console.error('Silakan ganti SUPABASE_URL dan SUPABASE_ANON_KEY di bagian CONFIGURATION pada file ini.');
            alert('Konfigurasi Supabase belum lengkap! Lihat console untuk instruksi.');
        }
    </script>
</body>
</html>
